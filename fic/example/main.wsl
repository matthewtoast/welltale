<!-- This is an example interactive audio story written in Welltale Story Language (WSL). -->

<!-- We start by setting up some basic metadata about the story, which we can embed as YAML front matter. -->
---
title: Example Quest
author: Matthew Trost
tags: [example, fantasy]
description: This example Welltale story shows how to use all Welltale Story Language features.

# Pronunciation mappings for the speech engine - for any less common words or fantastical terms
pronunciations:
  Trost: Troast
  Examplaria: exampLAHria

# Game data - you can define any custom data your story needs and reference it
# in template patterns like {{player.gold}} or scripts like <code>shop.potion * 3</code>
player:
  gold: 35
  inventory: ["bread"]

shop:
  potion: 30
  compass: 50
  sword: 20

# Macros are now defined directly in story files using <macro> tags
# These transform your tags based on rules to make story authoring easier

# Voices are defined in data files using this format
voices:
  narrator:
    prompt: British storybook narrator, classic deep voice, expressive
  merchant:
    prompt: Jovial merchant in a fantasy setting, slight Eastern European accent, persuasive
  rhymer:
    prompt: Swamp creature that speaks only in rhyme, melodic voice, slightly mischievous
  wretch:
    prompt: Wretched forest creature, lowly British accent, voice like a whisper through clenched teeth
  troll:
    prompt: Large deep-voiced troll with a growl, hungry and menacing, British accent
---

<!-- The <intro> tag plays content only once: when the player first begins a story. -->
<intro>
  <!-- The <music> tag generates a music clip according to a prompt -->
  <music duration="10000" background="true">
    Epic fantasy orchestral music for the beginning of an exciting, dangerous quest
  </music>

  <!-- <sleep> is used for creating a timed pause in the story flow, useful for building suspense -->
  <sleep duration="3000" />

  <!--
    The <p> tag plays spoken content, automatically converting the text to speech.
    You can use {{ }} template pattern to inject dynamic content into your text.
    Here, we are referencing values defined in our data.yml file.
  -->
  <p>
    You're playing {{title}}, by {{author}}.
  </p>
</intro>

<!-- The <resume> tag plays content any time a story is resumed. It does not play on the first playthrough. -->
<resume>
  <!-- If no `voice` is specified, a default voice will be used. -->
  <p>
    Welcome back to {{title}}, by {{author}}.
  </p>
</resume>

<!-- Macro definitions - these transform tags to make story authoring easier -->
<macro match="merchant">
  <rename to="p" />
  <set attr="voice" value="merchant" />
</macro>

<macro match="rhymer">
  <rename to="p" />
  <set attr="voice" value="rhymer" />
</macro>

<macro match="wretch">
  <rename to="p" />
  <set attr="voice" value="wretch" />
</macro>

<macro match="troll">
  <rename to="p" />
  <set attr="voice" value="troll" />
  <set attr="from" value="troll" />
</macro>

<!--
  The <origin> tag defines your story's actual starting point. It only plays once per story.
  It plays after the <intro> tag; or, if no <intro> tag is present, it played first.
  If no <origin> tag is given then playback will begin with the first top-level tag.
-->
<origin>
  <!-- The `voice` attribute here specifies the generated voice to use -->
  <p voice="narrator">
    Dark forces gather in the land of Examplaria.
  </p>
  
  <p voice="narrator">
    You've arrived at an ancient crossroads in the wilderness. The sun is setting.
    Two paths lie before you: one leads into a dark forest, the other toward a misty swamp.
    Which path do you choose?
  </p>

  <!--
    With the <input> tag, the story pauses to collect the user's input.
    Their input gets stored in an `input` state variable, which you can use in your story logic.
  -->
  <input />

  <!--
    The <llm:score> tag is one of many AI-based tags that lets you drive your story.
    It creates a data set with each attribute scored according to its value.
    The `key` tag determines what variable the data gets stored in.
  -->
  <llm:score
    key="choice"
    woods="the player chooses the woods"
    swamp="the player chooses the swamp">
    The player has a choice between visiting the woods and the swamp. Based on their input, which do they choose?
    {{input}}
  </llm:score>

  <if cond="choice.woods > choice.swamp">
    <p voice="narrator">
      You make your way down the path into the darkening forest.
    </p>
    <jump to="woods" />
  </if>

  <p voice="narrator">
    You trudge toward the misty swamp ahead.
  </p>
  <jump to="swamp" />
</origin>

<!--
  The <macro> tag lets you transform tags in your story to make authoring easier.
  Instead of writing `<p voice="narrator">` over and over, this macro lets us use `<narrator>` anywhere in the story.
-->
<macro match="narrator">
  <rename to="p" />
  <set attr="voice" value="narrator" />
</macro>

<!--
  <div> tags are just containers for content. Container tags are in the order they are written.
  You can also
-->
<div id="woods">
  <narrator>
    As your eyes adjust to the dark, you look around at the trees.
  </narrator>

  <narrator>
    <!-- With the {% %} template pattern, you can use a prompt for generative AI to create story content. -->
    You see {% short, suspenseful description of a dark forest in present tense %}.
  </narrator>

  <!--
    The <checkpoint> tag indicates a point to which the player may rewind the story.
    Every visit to an <input> also creates a checkpoint, but you can use <checkpoint> to explicitly create one.
  -->
  <checkpoint />

  <narrator>
    From somewhere within the thicket of trees, you hear a strange voice.
  </narrator>

  <!-- The <wretch> tag is defined by the macro at the top of this file -->
  <wretch>
    Who goes there...?
  </wretch>

  <narrator>
    Upon hearing this voice, you freeze in your tracks. You can't see where the voice came from.
  </narrator>

  <wretch>
    I be the keeper of these woods.
    I eat all who tresspass, starting with theys toes.
    Only thems who answer me riddle may pass.
  </wretch>

  <!--
    The <llm:generate> tag can be used to generate content using AI from a prompt.
    Here we also use {$ $} template pattern syntax for inline JavaScript fragments.
  -->
  <llm:generate
    key="riddle"
    question="the full riddle question"
    answer="answer to the riddle">
    Create a short riddle that works in a medieval British fantasy setting.
    Give your response in two parts: the question, and the answer.
    The answer should be a single word related to {$ randElement(["summer", "winter", "autumn", "spring"]) $}.
    The question should be short and lyrical, with grammar like Gollum.
  </llm:generate>

  <wretch>
    Answer me this:  
    {{riddle.question}}
  </wretch>

  <narrator>
    How do you answer the riddle?
  </narrator>

  <!-- Input can be stored under any state variable you choose, using the `key` tag. -->
  <input key="reply" />

  <!--
    With the <script> tag you can use JavaScript to write programmatic logic.
    By default, all state variables are available in the scope of this script.
    To set a state variable (i.e. to be available after the script runs), use the `wsl.set(key, value)` function.
  -->
  <script>
    wsl.set("riddleSolved", reply.includes(riddle.answer))
  </script>

  <if cond="riddleSolved">
    <!-- Single-bracket syntax can be used to add emotional inflection to the generated speech -->
    <wretch>
      Ye solved me riddle, [reluctantly] so I'll let ye pass.
      [forcefully] Come not again to these woods, traveler.
    </wretch>
    <narrator>
      With your life (and toes) intact, you continue through the forest.
      Eventually the woods thin and you find yourself in an open field.
    </narrator>
  </if>
  <if cond="!riddleSolved">
    <wretch>
      Ye answer was wrong. Which makes me happy, as I've not had a meal in days.
      Hee hee hee, don't even try to run away...
    </wretch>
    <narrator>
      Before you know it, you find yourself in the clutches of this strange creature.
      Giggling, it begins taking off your shoes.
    </narrator>
    <!-- The <sound> tag generates or plays sound effects. -->
    <sound duration="5000">
      Grotesque sound of a mouth chewing and gnawing on meat and gristle
    </sound>
    <jump to="dead" />
  </if>

  <!-- The <jump> tag navigates to another section by its id. -->
  <jump to="outpost" />
</div>

<div id="swamp">
  <!-- The <data> tag loads structured data (JSON or YAML) and stores it in a state variable. -->
  <data key="unrhymable" format="yaml">
    - orange
    - silver
    - purple
    - month
    - ninth
    - pint
    - wolf
    - opus
    - dangerous
    - marathon
    - discombobulate
    - rhythm
  </data>

  <narrator>
    You wade into a murky swamp.
    The water reaches your knees, and something moves in the fog ahead.
    Soon, a large, slimy creature emerges from the muck.
  </narrator>

  <!-- The <rhymer> tag is defined by the macro at the top of this file -->
  <rhymer>
    Speak a word, and I'll reply in rhyme.
    I'll keep you here till the end of time.
  </rhymer>

  <narrator>
    You try to pass the creature, but it blocks your way.
    Perhaps something you say will cause it to let you pass.
  </narrator>

  <!-- The <var> tag declares or updates a state variable with a name, value, and optional type. -->
  <var name="rhymeTurns" value="0" type="number" />

  <!-- The <while> tag creates a loop that continues while its condition is true. -->
  <while cond="rhymeTurns < 10">
    <input />
    
    <llm:parse
      key="playerWord"
      lastWord="the last word the player said">
      {{input}}
    </llm:parse>

    <!-- Use <script> to check if the player said an unrhymable word and increment the turn counter. -->
    <script>
      const word = playerWord.lastWord?.toLowerCase() || "";
      const isUnrhymable = unrhymable.some(w => word.includes(w));
      wsl.set("stumped", isUnrhymable);
      wsl.set("rhymeTurns", rhymeTurns + 1);
    </script>

    <if cond="stumped">
      <rhymer>
        [confused] {{playerWord.lastWord}}? But that word... I cannot...
        My rhyming power, I have forgot!
      </rhymer>
      <narrator>
        The creature stumbles backward, thoroughly befuddled.
        You quickly wade past while it mutters to itself.
        Eventually the swamp ends and you find yourself in an open field.
      </narrator>
      <!-- The <break> tag exits the current loop immediately. -->
      <break />

      <!-- Else blocks are a hidden feature; they ONLY work when placed INSIDE of an If block -->
      <else>
        <rhymer>
          {% Create a short rhyming response to "{{playerWord.lastWord}}" that blocks the path %}
        </rhymer>
        <if cond="rhymeTurns >= 5">
          <narrator>
            Perhaps you should try a word that's harder to rhyme...
          </narrator>
        </if>
      </else>
    </if>

  </while>

  <jump to="outpost" />
</div>

<div id="outpost">
  <!-- Initialize player's inventory from external data file -->
  <script>
    wsl.set("gold", player.starting_gold);
    wsl.set("inventory", player.starting_inventory);
  </script>

  <narrator>
    There is a stone outpost here with a small wooden door. You push it open and find a merchant inside.
  </narrator>

  <!-- The <merchant> tag is defined by the macro at the top of this file -->
  <merchant>
    [enthusiastically] Ah, a customer! Welcome, welcome! I have many fine wares for sale!
  </merchant>

  <!-- Define reusable transaction blocks -->
  <block id="buy-item">
    <if cond="gold >= price">
      <merchant>
        Excellent choice! The {{item}} is yours for {{price}} gold.
      </merchant>
      <script>
        // Write to session state to persist beyond block scope
        ctx.session.state.gold = gold - price;
        ctx.session.state.inventory = [...inventory, item];
      </script>
      <narrator>
        You purchase the {{item}}. You now have {{gold}} gold remaining.
      </narrator>
    </if>
    <if cond="gold < price">
      <merchant>
        [apologetically] Ah, but you need {{price}} gold for the {{item}}. You only have {{gold}}.
      </merchant>
    </if>
  </block>

  <block id="sell-item">
    <script>
      const hasItem = inventory.includes(item);
      wsl.set("hasItem", hasItem);
    </script>
    <if cond="hasItem">
      <merchant>
        I'll give you {{price}} gold for your {{item}}.
      </merchant>
      <script>
        // Write to session state to persist beyond block scope
        ctx.session.state.gold = gold + price;
        ctx.session.state.inventory = inventory.filter(i => i !== item);
      </script>
      <narrator>
        You sell the {{item}}. You now have {{gold}} gold.
      </narrator>
    </if>
    <if cond="!hasItem">
      <merchant>
        [confused] But you don't have a {{item}} to sell me!
      </merchant>
    </if>
  </block>

  <merchant>
    I buy and sell items: {$ Object.entries(shop).map(([name, price]) => `${name} for ${price} gold`).join(', ') $}.
    What catches your eye?
  </merchant>

  <narrator>
    You have {{gold}} gold. Your inventory contains {$ inventory.join(', ') $}.
    What would you like to do?
  </narrator>

  <var name="merchantDone" value="false" type="boolean" />

  <while cond="!merchantDone">
    <input />

    <!-- Use the <llm:tag> tag to classify the player's intent -->
    <llm:tag
      key="intent"
      buy_potion="wants to buy a potion"
      buy_compass="wants to buy a compass"
      buy_sword="wants to buy a sword"
      sell_potion="wants to sell a potion"
      sell_compass="wants to sell a compass"
      sell_sword="wants to sell a sword"
      leave="wants to leave or is done shopping">
      {{input}}
    </llm:tag>

    <if cond="intent.includes('buy_potion')">
      <yield to="buy-item" item="potion" price="{$ shop.potion $}" />
    </if>
    
    <if cond="intent.includes('buy_compass')">
      <yield to="buy-item" item="compass" price="{$ shop.compass $}" />
    </if>

    <if cond="intent.includes('buy_sword')">
      <yield to="buy-item" item="sword" price="{$ shop.sword $}" />
    </if>

    <if cond="intent.includes('sell_potion')">
      <yield to="sell-item" item="potion" price="{$ shop.potion $}" />
    </if>

    <if cond="intent.includes('sell_compass')">
      <yield to="sell-item" item="compass" price="{$ shop.compass $}" />
    </if>

    <if cond="intent.includes('sell_sword')">
      <yield to="sell-item" item="sword" price="{$ shop.sword $}" />
    </if>

    <if cond="intent.includes('leave') || intent.length === 0">
      <merchant>
        [cheerfully] Come back anytime, friend! Safe travels!
      </merchant>
      <var name="merchantDone" value="true" type="boolean" />
    </if>

    <if cond="!intent.includes('buy') && !intent.includes('sell')">
      <narrator>
        Anything else? You can buy items, sell items, or leave.
      </narrator>
      <continue />
    </if>
  </while>

  <narrator>
    You leave the outpost and continue on your journey.
  </narrator>
  
  <jump to="troll" />
</div>

<div id="troll">
  <narrator>
    After a long walk, you come across an impassable river.
    Over the river spans a rickety wooden bridge.
    A large troll crawls out from beneath and blocks your way.
  </narrator>

  <troll>
    I shan't let ye cross me bridge unless ye pay me toll.
    What have ye to pay with?
  </troll>

  <!--
    With <include> you can pull in separately defined content by referencing its `id` attribute.
    In this case, we're referencing the content inside <module id="troll"> to be included here.
  -->
  <include id="troll" />
</div>

<!--
  There's nothing special about the <module> tag - by default, it will be ignored, so we can use
  it as a container for content that we can reference using <include>. You could keep this here
  or put it into a different file.
-->
<module id="troll">
  <var name="trollSatisfied" type="boolean" value="false" />
  <var name="offeredItem" value="" />
  <var name="attempts" type="number" value="0" />

  <narrator>
    You have {$ inventory.join(', ') $} and {{gold}} gold coins.
    Can you convince the troll to let you pass?
  </narrator>

  <while cond="!trollSatisfied">
    <input />

    <var name="attempts" value="{$ attempts + 1 $}" />

    <if cond="attempts > 5">
      <narrator>
        Perhaps it's not just what you offer, but how well you argue its value that matters to the troll.
      </narrator>
    </if>

    <llm:line
      key="trollResponse"
      as="troll">
      You are a bridge troll who demands payment to cross.
      Just being offered an item or gold for payment isn't enough - you need to be convinced of its value.
      <when cond="!offeredItem">
        The traveler hasn't offered anything yet. Be impatient and demanding.
      </when>
      <when cond="offeredItem">
        The traveler offered {{offeredItem}}. Consider their argument about its value.
        If they make a good case about why {{offeredItem}} is valuable, let them pass.
      </when>
    </llm:line>

    <troll>{{trollResponse}}</troll>

    <llm:parse
      key="analysis"
      offered="what item the player offered (bread, sword, potion, gold, or null)"
      convinced="whether the troll was convinced by the player's argument">
      The player is trying to convince the troll to let them pass the bridge.
      The troll will only let them cross if convinced by the player's persuasion.
      The player said: {{input}}
      The troll said: {{trollResponse}}
      Now assess whether the troll was convinced by what was offered.
    </llm:parse>

    <script>
      if (analysis.offered && !offeredItem) {
        wsl.set("offeredItem", analysis.offered);
      }
      if (analysis.convinced) {
        wsl.set("trollSatisfied", true);
      }
    </script>
  </while>

  <troll>
    <when cond="offeredItem">
      I'll take ye {{offeredItem}}, then.
    </when>
    <when cond="!offeredItem">
      Ye've convinced me with yer words alone.
    </when>
  </troll>

  <narrator>
    The troll steps aside, grumbling but satisfied with the trade.
  </narrator>

  <jump to="win" />
</module>

<div id="dead">
  <narrator>
    Unfortunately, you have perished.
    Another adventurer will have to take up your quest.
  </narrator>

  <!--
    The <end> tag ends the story and causes the game to exit.
    If an <outro> is present, it will also be played before the game exits.
  -->
  <end />
</div>

<div id="win">
  <narrator>
    Having survived multiple perils, you look out at the horizon with optimism.
    You forge ahead, ready to continue your adventure.
    The end.
  </narrator>
  <end />
</div>

<!-- The <outro> tag plays once at the end of the story, after all other story content has been finished. -->
<outro>
  <p>
    Thank you for playing {{title}}, by {{author}}.
    We hope you've enjoyed your adventure.
  </p>
</outro>
